<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <title>Pencarian Al-Qur'an Akurat</title>
  <style>
    body { font-family:sans-serif; max-width:700px; margin:auto; padding:2em; }
    input, button { padding:0.5em; font-size:1em; }
    .result { margin-top: 1em; padding: 1em; background: #f9f9f9; border-radius: 8px; }
    .ayah { direction: rtl; font-size: 1.5em; margin-top: 0.5em; }
    .meta { font-size: 0.95em; color: #444; }
    a { text-decoration: none; color: #007b8a; }
  </style>
</head>
<body>

  <h2>Cari Kata dalam Al-Qur'an</h2>
  <input type="text" id="query" placeholder="Contoh: ÿßŸÑÿ±ÿ≠ŸÖŸÜ, kasih sayang" onkeydown="if(event.key === 'Enter') searchQuran()" />
  <button onclick="searchQuran()">Cari</button>

  <div id="results"></div>

  <script>
    const base = window.location.hostname.includes("netlify")
      ? "https://tadabbur.netlify.app"
      : "https://dickymiswardi.github.io/tadabbur";

    function stripHarakat(str) {
      return str.normalize('NFD').replace(/[Ÿã-Ÿü]/g, '');
    }

    async function searchQuran() {
      const qRaw = document.getElementById('query').value.trim();
      const q = stripHarakat(qRaw);
      const resDiv = document.getElementById('results');
      resDiv.innerHTML = '';

      if (!q) return resDiv.textContent = '‚ùó Masukkan kata pencarian.';

      resDiv.innerHTML = 'üîç Sedang mencari...';

      try {
        const res = await fetch(`https://api.alquran.cloud/v1/search/${encodeURIComponent(qRaw)}/all/ar`);
        const json = await res.json();

        if (!json.data?.matches || json.data.matches.length === 0) {
          resDiv.innerHTML = '‚ùå Tidak ditemukan.';
          return;
        }

        const seen = new Set();
        const filteredMatches = json.data.matches.filter(m => {
          const key = `${m.surah.number}:${m.numberInSurah}`;
          if (seen.has(key)) return false;
          seen.add(key);
          return true;
        });

        const fetchAyahs = filteredMatches.slice(0, 20).map(async match => {
          const surah = match.surah.number;
          const ayat = match.numberInSurah;
          const url = `https://api.alquran.cloud/v1/ayah/${surah}:${ayat}/ar`;
          try {
            const response = await fetch(url);
            const data = await response.json();
            const ayatText = data.data.text;
            return {
              success: true,
              text: ayatText,
              surahName: data.data.surah.name,
              surahNumber: data.data.surah.number,
              ayatNumber: data.data.numberInSurah,
              containsQuery: stripHarakat(ayatText).includes(q)
            };
          } catch {
            return { success: false };
          }
        });

        const results = await Promise.allSettled(fetchAyahs);

        const ayahs = results
          .filter(r => r.status === 'fulfilled' && r.value.success)
          .map(r => r.value);

        const matchLangsung = ayahs.filter(a => a.containsQuery);
        const tidakLangsung = ayahs.filter(a => !a.containsQuery);
        const finalList = matchLangsung;

        if (finalList.length === 0) {
          resDiv.innerHTML = '‚ùå Tidak ditemukan (semua ayat gagal diambil).';
          return;
        }

        resDiv.innerHTML = finalList.map(a => {
          const link = `${base}/?surah=${a.surahNumber}&ayat=${a.ayatNumber}`;
          return `
            <div class="result">
              <div class="meta">üìñ <a href="${link}" target="_blank">${a.surahName} (${a.surahNumber}:${a.ayatNumber})</a></div>
              <div class="ayah">${a.text}</div>
            </div>
          `;
        }).join('');

      } catch (err) {
        console.error(err);
        resDiv.innerHTML = '‚ùå Gagal memuat data.';
      }
    }
  </script>

</body>
</html>
